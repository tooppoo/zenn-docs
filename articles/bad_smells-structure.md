---
title: "「不吉なにおい」考 - 「不吉なにおい」の構造について"
emoji: "👃"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["コードの不吉なにおい"]
published: false
---

本記事は、 [DDD-Community-Jp Advent Calendar 2020](https://qiita.com/advent-calendar/2020/dddcj) の22日目です。

----

# はじめに
## 概要
この記事は、以下の記事の内容を受けて、私達が時折直観的に感じ取る「不吉なにおい」について、その認識としての性質および構造の考察を試みたものとなります。
- [@t2-kob](https://twitter.com/t2kob1) さんによる記事 [「RDRA と EventStroming(デザインレベル) の組み合わせの可能性」](https://qiita.com/t2-kob/items/3d1ec6a780107036d6b2)
- [@jnuank_](https://twitter.com/jnuank_) さんによる記事 [「モデルの不吉なにおい」](https://jnuank.hatenablog.com/entry/2020/12/14/094851)

ドメイン駆動設計に関するコミュニティであるDDD-Commumity-JpのDiscordサーバー内で現在(2020/12/19時点)も実施されているイベント（通称「モデリング会」）での体験を基に、これらの記事は記述されています。これら記事内では、モデリングの最中でも「コードの不吉なにおい」に類似した体験があること、その体験は「コードの不吉なにおい」同様にある程度の分類が可能であることが、それぞれ示されています。

本記事は、こうした「コードの不吉なにおい」に類似した認識がモデリングの最中でも、すなわちプログラムコード以外を対象とした活動においても見いだされた点に注目し、「不吉なにおい」というメタファを通じて私達が抱いている認識がどのような構造と性質を持っているのかについて、考察を試みたものです。

## 注意事項
本記事は、「不吉なにおい」というメタファで表現される認識についての考察を試みるものです。何が「不吉なにおい」として認識されるかの解明、すなわちコードやモデル表現等に対して、いつ、どのように手を入れるべきかという基準の明確な定義を試みるものではありません。

## 表記について
本記事では「臭い」「匂い」「におい」といった表記方法について、引用箇所を除いて、ひらがな表記の「におい」で統一します。

# 「不吉なにおい」
ここでは、「不吉なにおい」という同一のメタファを用いながらコードとモデル表現というそれぞれ異なる対象へとそのメタファを適用した、２つの表現を比較します。

## 「コードの不吉な臭い」
掲題の「不吉なにおい」は、プログラミングあるいはソフトウェア開発の文脈で使われてきた「コードの不吉な臭い(Bad Smells in Code)」という言葉が由来となります（以降では、表記の統一と簡単のため、「におい」表記で統一します）。これはもともとKent Beckによる造語であり、Martin Fowlerの著書「リファクタリング」の第三章で公に使用されたものです[^1]。
「コードの不吉なにおい」は、リファクタリングに取り組む「きっかけ」を表す比喩として与えられた言葉であり、具体的な基準や状態を指すものではありません。『リファクタリング』(Fowler 2019)では、こうした「コードの不吉なにおい」の種類、すなわちリファクタリングを開始する「きっかけ」となる兆候を分類し、名前をつけ、有効な対処方法を与えることで、リファクタリングをいつ始め、いつ終了するかのいくつかの判断材料を提示しています[^2]。

「コードの不吉なにおい」は、あるコードを対象としたリファクタリングへ進む「きっかけ」を示します。「コードの不吉なにおい」を認識した人間は、その認識をきっかけにリファクタリングへ、すなわち「におい」を認識した対象であるコードへと「外部から見た時の振る舞いを保ちつつ、理解や修正が簡単になるように、ソフトウェアの内部構造を変化させ」るよう駆り立てられるのです[^3]。

[^1]: https://wiki.c2.com/?CodeSmell
[^2]: Martin Fowler(2019)『リファクタリング 既存のコードを安全に改善する 第2版』p.73
[^3]: Martin Fowler(2019)『リファクタリング 既存のコードを安全に改善する 第2版』p.45

## 「モデルの不吉なにおい」
冒頭の記事では、「コードの不吉なにおい」で使われた「臭い」というメタファをコードだけでなくソフトウェア適用対象の各種モデルを表現する図・テキスト（以下、「モデル表現」）に対しても適用しており、「コードの不吉なにおい」に倣って「モデルの不吉なにおい」と呼称しています。

> その中で最も大きな影響を与えていたように感じたのは『皆の理解がずれてしまった』という点です。
> そう、実装を進める中で知らず知らずのうちにお互いの話す言葉や単語の前提がずれ始めていたのです。
> (中略)
> コミュニケーションの不一致を契機 として、いわゆる『コードのにおい』と同じように『モデルのにおい』を感じ取っているのです。[^4]

> 上で取り上げた記事では、それになぞらえて「モデルに対する皆の理解がずれてしまう」「モデルに対しての違和感が発生する」の状態をモデルの不吉なにおいと表現しています。
> (中略)
> ここでは「モデルの不吉なにおい」というのを、「モデリングか実装の手を止め、モデル自体に立ち返って見直す必要性を感じさせる場面」としておきます。 [^5]

記事を見ると、「コードの不吉なにおい」と同じく「不吉なにおい」というメタファで表現される何らかの現象が、コードではなくモデル表現を対象として直観されている様子が伺えます。そしてまた、そうした「不吉なにおい」を認識することを「きっかけ」として、「モデリングか実装の手を止め、モデル自体に立ち返って見直」そうという動き、すなわち、モデル表現という対象への「修正」「見直し」といった働きかけが促されている様が綴られています。

この「修正」「見直し」は、「モデルに対する皆の理解がずれてしま」った状態、あるいは「モデルに対しての違和感が発生」した状態を解消するために行われる傾向にあります。モデル表現内部にあらわれている言葉を改め、言葉や図の間の繋がりを改め、曖昧な部分と明確な部分の切り分けを改めます。
こうした「修正」「見直し」は、最終的にどこを目指して行われているのか。モデル表現を、すなわち「不吉なにおい」を認識した対象を、より理解しやすく、より誤りを検出しやすい形へと近づけていく、そのような方向性が有るように見えます。

[^4]: @t2-kob https://qiita.com/t2-kob/items/3d1ec6a780107036d6b2#-%E5%AE%9F%E8%A3%85%E3%81%A8%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%B8%8D%E5%90%89%E3%81%AA%E3%81%AB%E3%81%8A%E3%81%84 「コードの不吉なにおい」について、記事本文中では一部省略されて「コードのにおい」と記述されている
[^5]: @jnuank_ https://jnuank.hatenablog.com/entry/2020/12/14/094851#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB

## 「不吉なにおい」の基礎的構造と性質
「コードの不吉なにおい」にせよ「モデルの不吉なにおい」にせよ、「不吉なにおい」を私達が認識する時、それぞれ対象を異にしつつも共通しているのは、「理解や修正が簡単になるように修正されなければならない」という対象への確信です。

「コードの不吉なにおい」では、リファクタリングを開始する「きっかけ」の比喩として、「不吉なにおい」が記述されています。この「不吉なにおい」という認識を「きっかけ」として、私達はリファクタリングという活動へと駆り立てられます。その「駆り立て」には、対象のコードを「理解や修正が簡単になるように修正されなければならない」という、有る種の確信が含まれます。

他方、「モデルの不吉なにおい」は「モデルに対する皆の理解がずれてしまう」「モデルに対しての違和感が発生する」「モデリングか実装の手を止め、モデル自体に立ち返って見直す必要性を感じさせる場面」として記述されています。そうした「不吉なにおい」という認識を得た時、人は「モデリングか実装の手を止め、モデル自体に立ち返って見直」し、より理解や修正（例えば、修正すべき箇所の検出という点で）がより簡単になるようにモデル表現を改めようとします。そこにはやはり、対象のモデル表現は「理解や修正が簡単になるように修正されなければならない」という形式の確信が存在します。

「コードの不吉なにおい」と「モデルの不吉なにおい」は、それぞれ対象が異なります。対象が異なる故に、こうした「不吉なにおい」を認識した後の具体的なふるまいの内容も異なるでしょう。「不吉なにおい」という認識が発生する具体的箇所や、具体的内容も、それぞれ一致しない場面が多いと推測することになるでしょう。

一方で、以下の点については、両者は一致していると考えられるのではないでしょうか。
- 何かしらの対象を取る
	- 一方はコードであり、一方はモデル表現である
- 対象について、その対象を理解・修正することをより簡単にしようという働きかけへ、認識者を駆り立てる
	- 一方の認識は個々のコードやコード構造に、一方の認識はモデル表現の図・テキスト・関連線などに、それぞれ認識者を向かわせる
- 「対象は上記のような働きかけを受けるべきだ」という確信を伴う

ここであげた構造および性質は、コードを対象とした時にせよモデル表現を対象した時にせよ、いずれの場合にも当てはまります。その意味で、これらはコードのみ、あるいはモデル表現のみに成立する要素ではないと言えるでしょう。むしろこの構造および性質こそここで言う「不吉なにおい」という認識の基礎的構造および性質であり、「コードの不吉なにおい」「モデルの不吉なにおい」はこの基礎的構造および性質をコードやモデル表現という具体的な対象へ適用した一例として位置づけられそうです。

この基礎的構造および性質をまとめて、「コードの不吉な臭い」「モデルの不吉なにおい」の一般化としての「不吉なにおい」を定義してみます。
- 「不吉なにおい」は、それを認識する何らかの対象を取る
- 「不吉なにおい」は、それを認識した人に、対象は「理解・修正が簡単になるように修正されるべきだ」という確信を抱かせる

この定義を受け入れるなら、私達はより一般的な概念としての「不吉なにおい」を手に入れたことになります。

# 「不吉なにおい」の構造
「コードの不吉なにおい」と「モデルの不吉なにおい」という、同一のメタファを用いながら異なる対象へとそのメタファを適用した２つの表現についてその特徴をそれぞれまとめ、さらに比較を行いました。結果、メタファを適用した対象こそ違えど全体構造としては然程類似性を失っていないことを見出し、最終的には「不吉なにおい」というより一般的な表現を得るに至りました。

ここからは、さらにこの「不吉なにおい」という認識形態について、より正確に言えば、この認識形態はどのような構造を持ち、その認識形態はどのような前提を要求しているのか、その分析と記述を試みます。

## 「不吉なにおい」を構成する確信
「コードの不吉なにおい」にせよ「モデルの不吉なにおい」にせよ、「不吉なにおい」を私達が認識する時、そこには「理解や修正が簡単になるように修正されるべきだ」という対象への確信があります。この確信を、より細かく観察してみましょう。

まず「修正されるべきだ」という確信は、無方向なものではないことがわかります。何かしらの「修正」さえ行われれば内容は問わないのではなく、「理解や修正が簡単になるように」という制約も、同時に含まれています。
また、「修正されるべきだ」という記述からは、有る種の義務的（場合によっては、倫理的）な確信が含まれていることが見て取れます。

上記のことから、「理解や修正が簡単になるように修正されるべきだ」という確信は、制約や義務など、さらにいくつかの種類の確信が複合することによって構成されていると考えられそうです。そうした構成要素としての確信の内訳として、以下のような分類と記述を考えてみます。

1. **「その対象は理解や修正が簡単ではない、あるいは困難である」という確信**。他者から見ても同様の感想を抱くかはわかりませんが、少なくとも観測者にとっては、その対象（の目的や意図や背景）を理解したり、あるいはその内容をより正しく変更することは容易ではないことが確信されています。この確信が無い、あるいは逆に「理解や修正が簡単である」という確信すら抱いているならば、私達はただ対象および自身のあるがままに（特に事前に手を加える事無く）理解や修正を試みるでしょう。
1. **「理解や修正が困難なのは、現状の対象自体に原因がある」という確信**。その対象を認識している自身の能力や知識ではなく、その対象自身の状態や有り様に、その対象を理解・修正する困難さの多くが（少なくとも、自身よりも大きな割合で）由来している。そうした確信があるからこそ、自身に対してではなく、対象に対して「修正」という働きかけを試みるのです[^6]。逆に、自身の能力や知識に困難さの多くが由来すると確信したなら、次の行動は自身の変化を目的としたもの（学習、調査による知識の獲得など）となるでしょう。
1. **「その対象が持つ理解・修正の困難性は、人間の手によって減少させることができる」という確信**。1.~3.で確信された対象起因の困難性に対して「修正されなければならない」と確信する時、そこには「修正」が可能である、すなわち人間の働きかけによってその困難性を減少させることが可能であるという確信が前提されています。飛行機が空を飛ぶことについて、その仕組を理解するのが困難だからといって、飛行機が空を飛ぶ仕組みそのものを「修正」しようと試みることはないでしょう。それは、飛行機が空を飛ぶ仕組みを理解する困難性を人間の手によって減少（変化）させる余地が確信できないためです。他方、コードやモデル表現の困難性については、そこに人間が干渉する余地が確信されるからこそ、「修正」を試み、かつ「されなければならない」という確信へ至る可能性が生じます。
1. **「この困難性は減少するべきだ」という確信**。1.~4.の確信が抱かれたとして、最終的に、その困難性について「このままでも構わない」あるいは「このままがむしろ好ましい」という確信が抱かれたなら、すなわちその困難性が減少することが有る種の義務として見いだされなければ、「この困難性は減少べきだ」という確信には至り得ません。対象の観察が苦痛であったり、将来的な経済活動に支障を来す危険が予期されたり、ただ美しくないという感覚であったり、何かしらの形で「この困難性は減少するべきだ」という確信が生じて、はじめて「（理解や修正が簡単になるように）修正されるべきだ」という確信へと至ります[^7]。

本記事では、こうして見いだされた構成要素としての確信を、それぞれ
1. 困難の確信（対象を理解・修正することは困難であるという確信）
1. 原因の確信（困難さの原因は対象にあるという確信）
1. 減少可能の確信（困難さは人間によって減少可能であるという確信）
1. 義務の確信（その困難さは減少するべきだという確信）

と呼ぶこととします。

[^6]: 本記事の「確信」は、あくまで個人の瞬間的な認識体験です。「原因は対象にある」と確信することと、その確信が一般に同意されるかどうかは別の問題です。ここにギャップがある時、「リファクタリング」を巡るコミュニケーション上の衝突が発生するとも考えられそうです。

[^7]: ここの「修正されるべきだ」という確信についての議論では、予算・人員・時間といった外部条件からくる「このままで良い」「このままが良い」といった判断は取り扱っていません。ここで問題としているのは、そうした具体的情報・制約・思考に基づく**判断**ではなく、対象を通じて得た直観的認識への**確信**です。

## 「重複したコード」を例に
前節で、「不吉なにおい」を構成する要素としての4つの確信を記述しました。
この節では、こうして見いだされた4つの確信が実際にどのように現れてくる、あるいは見出しうるのか、具体的な「不吉なにおい」の例を基に検討してみます。

「リファクタリング」(Fowler 2019)では、「コードの不吉なにおい」の具体的な種類の一つとして、「重複したコード」を挙げています。「リファクタリング」では、以下のように説明されています。

> 同じ構造のコードが2か所以上にある場合、1か所にまとめることができると、より良いプログラムになります。コードに重複があると、コピーされた箇所に出くわすたびに、似ているけれども違う部分はないか、 注意深く読み込まなければならなくなります。重複したコードを修正することになった際には、重複部分を漏れなく見つけ、すべてに同様の修正を施していく必要があります。[^8]

この「不吉なにおい」を題材に、先に上げた4つの確信が「不吉なにおい」に実際に含まれていること、「不吉なにおい」を構成する確信として見いだせることを、以下で確認します。

### 「困難の確信」
この説明からは、「注意深く読み込まなければならなくな」るという理解についての困難さ、および「すべてに同様の修正を施していく必要があ」るという修正への困難さに対する確信が読み取れます。すなわち「困難の確信」が、「重複したコード」という「不吉なにおい」には含まれています。

### 「原因の確信」
また、上記の「困難の確信」は、自身の知識や理解の能力ではなく、対象となるコードに由来することが確信されています。自身の知識やプログラミング技術に問題が有るために「注意深く読み込まなければならなくな」ったり、「すべてに同様の修正を施していく必要」が生じているのではなく、その原因は、対象のコード内部に重複が存在していることにあるという確信、すなわち「原因の確信」がここにあります。

### 「減少可能の確信」
『リファクタリング』(Fowler 2019)では、先述の「重複したコード」の説明の後、「関数の抽出」「ステートメントスライド」「メソッドの引き上げ」などを挙げ、それらの方法によって問題の解決、あるいは解決しやすい状態にできると説明しています。
この説明からは、「重複したコード」という「不吉なにおい」を通じて確信された困難がこれらの方法で大なり小なり減少するという確信が、すなわち「減少可能の確信」が読み取れます。

### 「義務の確信」
「重複したコード」が「不吉なにおい」として、すなわち「理解や修正が簡単になるように修正されるべきだ」という確信として認識されている時点で、そこには「修正されるべきだ」という確信が含まれています。
「不吉なにおい」として認識された対象はその種類や内容を問わずほぼ必然的に、「義務の確信」を前提としていると考えて良いでしょう。

### その他の例について
今回は『リファクタリング』から「重複したコード」を、すなわち「コードの不吉なにおい」の具体例を題材として、4つの確信がそこに現に含まれていること、実際に「不吉なにおい」の具体例が4つの確信によって構成されていることを確認しました。

他の「コードの不吉なにおい」および「モデルの不吉なにおい」の具体例についても当てはまるかの検証は、ここでは省略します。また、筆者自身全ての例について検証ができているわけではありません。しかし、ほとんど全ての具体例について、この構造が共通に見いだせるのではないかと筆者は考えています。

# まとめ
本記事は、「コードの不吉なにおい」と「モデルの不吉なにおい」が、いずれも「不吉なにおい」というメタファを用いて何らかの認識を表現しようとしている点への注目から出発しました。

第一に、両者がこのメタファを用いて表現しようとした内容を整理し、その共通点をまとめました。その結果、両者をより一般化した表現としての「不吉なにおい」という言葉を定義しました。

続いて、「不吉なにおい」という認識の構造について、より詳細に分析することを試みました。その結果、「不吉なにおい」は
1. 困難の確信
2. 原因の確信
3. 減少可能の確信
4. 義務の確信

という４つの確信によって構成されていることを確認できました。また、現に『リファクタリング』で挙げられている「コードの不吉なにおい」を題材として、実際にこれらの確信がそこに含まれていることを確認しました。

# 応用
現実のプログラミングやモデリング、あるいは設計など、様々な活動の中で「不吉なにおい」あるいはそれに類する認識を抱くことがあるでしょう。それは時に「コードの不吉なにおい」、時に「違和感」、時に「気持ち悪い」という言葉で表現されるものかもしれません。

そうした直観は時に、論理的推論や情報の積み重ねからは到達できないような、飛躍を伴った課題解決方法、あるいは問題の発見へ至ることがあります。一方で、それは多くの場合に論理的推論や情報の分析を経由していないがために、他者への共有や、妥当性の検証が困難です。「不吉なにおい」が、実際には思い込みや錯覚である可能性も有ります。

ここで見いだされた4つの確信は、他者へ共有するための言語化や、妥当性の検証を助ける道具として活用できるのではないかと考えています。

例えばあるコードから「不吉なにおい」を感じた時であれば
- 「困難の確信」に基づいて「この対象はどんな困難をもたらすと確信しているのか？」と問う
- 「原因の確信」に基づいて「この困難は本当に対象に由来しているのか？自身の知識不足や技術不足が、対象を困難に見せているのではないか？」と問う
- 「減少可能の確信」に基づいて「本当にこの困難は減少可能なのか？このプロダクトの性質上、これは回避不能だったりしないか？減少可能なら、それはどのように減少するのか？」と問う
- 「義務の確信」に基づいて「これは本当に修正されるべきものなのか？実際には修正されなくて良い場合があり、私がそれを知らないだけなのではないか？」と問う

など、「不吉なにおい」の種類・性質・背景の言語化、および「不吉なにおい」という認識の妥当性を検証するような問いを立てられそうです（他にも、多様な問いを立てることができるでしょう）。

このように、「不吉なにおい」を構成するそれぞれの確信について「本当にこの確信は妥当なのか？」という問を立てることで、現実に直面する様々な「不吉なにおい」をより精緻に捉え、より的確な問題解決方法を見つける機会を増やせるのではないでしょうか。

# 課題：「不吉なにおい」のメカニズム
本記事で記述を試みたのは、実際に認識した「不吉なにおい」の構造にとどまります。なぜこのような認識が発生するのか、「不吉なにおい」というメタファで表現される種類の認識が、どのようなプロセスを通じてこのような構造を伴って私達の認識として立ち上って来るのかは、問われていません。
私達が何らかの対象を認識した時、その対象を私達がどのように捉え、どのように認識し、どのようにこのような構造を伴って意識に現れてくるのかは、未だ問われていません。

本記事の問として、さらに「不吉なにおい」という認識が生まれてくるそのメカニズムを問うことができたなら、そしてそのメカニズムを解明し定義付けることができたなら。
その時には、コードやモデル表現を記述するにあたって、どのような時に立ち止まり「修正」へと向かうべきなのか、その基準を見出すことができるのかもしれません。

# 参考資料
- [@t2-kob](https://twitter.com/t2kob1) 「RDRA と EventStroming(デザインレベル) の組み合わせの可能性」 https://qiita.com/t2-kob/items/3d1ec6a780107036d6b2 2020/12/19 03:01 最終閲覧閲覧
- [@jnuank_](https://twitter.com/jnuank_) 「モデルの不吉なにおい」 https://jnuank.hatenablog.com/entry/2020/12/14/094851 2020/12/19 02:45 最終閲覧閲覧
- WikiWikiWeb - Code Smell https://wiki.c2.com/?CodeSmell - 2020/12/19 01:39 最終閲覧
- Martin Fowler (2018) Refactoring: Improving the Design of Existing Code ( (2019)「リファクタリング 既存のコードを安全に改善する 第2版」)
